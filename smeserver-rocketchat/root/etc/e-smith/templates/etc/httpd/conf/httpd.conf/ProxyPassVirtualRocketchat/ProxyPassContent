{
    use esmith::DomainsDB;
    my $db = esmith::DomainsDB->open_ro;
    my $d  = $db->get($virtualHost);
    my $t  = $d->prop('ProxyPassTarget');

    if ( $port eq "80" ) {
        $OUT .= "    # Redirect Letsencrypt queries\n";
        $OUT .= "    RewriteRule ^/.well-known/acme-challenge(/.*|\$) https://%{HTTP_HOST}/.well-known/acme-challenge\$1 [L,R]\n";
        $OUT .= "    # Everything else goes to https\n";
        $OUT .= "    RewriteRule ^/(.*|\$) https://%{HTTP_HOST}/ [R,L]\n";
    }

    if ( $port eq "443" ) {
	$OUT .= "    # SSL Directives\n";
	$OUT .= "    SSLEngine on\n";

	$OUT .= "    RewriteEngine On\n";
    $OUT .= "    RewriteCond %{HTTP:Upgrade} =websocket [NC]\n";
    $OUT .= "    RewriteRule /(.*)           ws://localhost:3000/\$1 [P,L]\n";
    $OUT .= "    RewriteCond %{HTTP:Upgrade} !=websocket [NC]\n";
    $OUT .= "    RewriteRule /(.*)           http://localhost:3000/\$1 [P,L]\n";
    $OUT .= "    ProxyPassReverse / http://localhost:3000/\n";

    }
}
